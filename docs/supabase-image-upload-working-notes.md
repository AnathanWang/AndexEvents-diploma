# Supabase image upload ‚Äî working variant (avatars + events)

–î–∞—Ç–∞ —Ñ–∏–∫—Å–∞: 2025-12-12

–≠—Ç–æ—Ç —Ñ–∞–π–ª ‚Äî ¬´—è–∫–æ—Ä—å¬ª –¥–ª—è —Ä–∞–±–æ—á–µ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ Supabase Storage.
–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ —Å–Ω–æ–≤–∞ —Å–ª–æ–º–∞–µ—Ç—Å—è, —Å–≤–µ—Ä—è–π—Ç–µ—Å—å —Å –ø—É–Ω–∫—Ç–∞–º–∏ –Ω–∏–∂–µ.

## –ß—Ç–æ –∏–º–µ–Ω–Ω–æ –≤–∞–∂–Ω–æ (–∫–æ—Ä–æ—Ç–∫–æ)

- Buckets `avatars` –∏ `events` ‚Äî public.
- –í UI –ù–ï –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ `Authorization: Bearer <supabaseAnonKey>` –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (anon key ‚Äî –Ω–µ JWT).
- –ü—Ä–∏ upload –≤ Storage –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∑–∞–¥–∞—ë–º `contentType` —á–µ—Ä–µ–∑ `FileOptions(contentType: ...)`.
- –î–ª—è —Ñ–æ—Ç–æ —Å–æ–±—ã—Ç–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ–º `uploadBinary(bytes)` –≤–º–µ—Å—Ç–æ `upload(File)` (—É—Å—Ç—Ä–∞–Ω—è–ª–æ –∑–∞–≤–∏—Å–∞–Ω–∏—è/—Ç–∞–π–º–∞—É—Ç—ã).
- –ï—Å—Ç—å —Ç–∞–π–º–∞—É—Ç—ã + –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ ¬´–≤–µ—á–Ω–æ–≥–æ —Å–ø–∏–Ω–Ω–µ—Ä–∞¬ª).

## –ö–ª—é—á–µ–≤—ã–µ –º–µ—Å—Ç–∞ –≤ –∫–æ–¥–µ

### 1) –ê–≤–∞—Ç–∞—Ä–∫–∏ (upload)

- –†–µ–∞–ª–∏–∑–∞—Ü–∏—è: `lib/data/services/user_service.dart`
- –í–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏:
  - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ `contentType` –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é (helper –≤—Ä–æ–¥–µ `_inferImageContentType(ext)`)
  - `storage.from('avatars').upload(...)` —Å `FileOptions(contentType: ..., upsert: true)`
  - –¢–∞–π–º–∞—É—Ç—ã + –æ–±—Ä–∞–±–æ—Ç–∫–∞ `TimeoutException`/`SocketException` (–æ—Å–æ–±–µ–Ω–Ω–æ –ø–æ–ª–µ–∑–Ω–æ –Ω–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ)

### 2) –§–æ—Ç–æ —Å–æ–±—ã—Ç–∏–π (upload)

- –†–µ–∞–ª–∏–∑–∞—Ü–∏—è: `lib/data/services/event_service.dart`
- –í–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏:
  - –°–∂–∞—Ç–∏–µ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π (`ImageUtils.compressImage(...)`)
  - –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—É—Ç–∏: `events/<userId>/<timestamp>.<ext>`
  - –ó–∞–≥—Ä—É–∑–∫–∞ –∏–º–µ–Ω–Ω–æ —á–µ—Ä–µ–∑ `uploadBinary(bytes)`:
    - `final bytes = await compressedFile.readAsBytes().timeout(...)`
    - `await storage.uploadBinary(fileName, bytes, fileOptions: FileOptions(contentType: ...))`
  - Preflight `list()` (–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ bucket) + –æ–¥–∏–Ω retry –ø—Ä–∏ `TimeoutException`

### 3) –ö–æ–º–ø—Ä–µ—Å—Å–∏—è (—á—Ç–æ–±—ã –Ω–µ –∑–∞–≤–∏—Å–∞–ª–æ)

- –†–µ–∞–ª–∏–∑–∞—Ü–∏—è: `lib/core/utils/image_utils.dart`
- –í–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏:
  - –ö–æ–º–ø—Ä–µ—Å—Å–∏—è –∑–∞—â–∏—â–µ–Ω–∞ `timeout` (–Ω–∞–ø—Ä–∏–º–µ—Ä 20 —Å–µ–∫—É–Ω–¥)
  - –ü—Ä–∏ —Ç–∞–π–º–∞—É—Ç–µ ‚Äî fallback –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª

### 4) –ë–∞–∑–æ–≤—ã–π URL backend (–≤–∞–∂–Ω–æ –¥–ª—è —Ñ–∏–∑. —É—Å—Ç—Ä–æ–π—Å—Ç–≤)

- –†–µ–∞–ª–∏–∑–∞—Ü–∏—è: `lib/core/config/app_config.dart`
- –í–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏:
  - –ï—Å—Ç—å override —á–µ—Ä–µ–∑ `--dart-define=API_BASE_URL=...`
  - –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ, –µ—Å–ª–∏ —Ä–∞–Ω—å—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è `localhost` –∏ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –≤—Å—ë —É—Ö–æ–¥–∏–ª–æ –≤ —Ç–∞–π–º–∞—É—Ç

–ü—Ä–∏–º–µ—Ä –∑–∞–ø—É—Å–∫–∞ (–ø–æ–¥—Å—Ç–∞–≤—å—Ç–µ IP –≤–∞—à–µ–≥–æ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞ –≤ –æ–¥–Ω–æ–π Wi‚ÄëFi —Å–µ—Ç–∏):

- `flutter run --dart-define=API_BASE_URL=http://192.168.1.10:3000/api`

## UI: —á—Ç–æ –ù–ï –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –æ–±—Ä–∞—Ç–Ω–æ

- –ù–µ –¥–æ–±–∞–≤–ª—è—Ç—å `Authorization: Bearer ${AppConfig.supabaseAnonKey}` –≤ `CachedNetworkImage`/`CachedNetworkImageProvider`.
  - –≠—Ç–æ –ª–æ–º–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (anon key –Ω–µ —è–≤–ª—è–µ—Ç—Å—è JWT).

## –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –≤—Å—ë –æ–∫

- –í –ª–æ–≥–∞—Ö –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ —Å–æ–±—ã—Ç–∏—è –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–ª—è—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è:
  - `üü¢ [EventService] Upload successful!`
  - –∏ –ø—É–±–ª–∏—á–Ω—ã–π URL —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ `getPublicUrl(...)`

–ï—Å–ª–∏ —Å–Ω–æ–≤–∞ –ø–æ—è–≤–∏—Ç—Å—è —Ç–∞–π–º–∞—É—Ç –∏–º–µ–Ω–Ω–æ –Ω–∞ storage upload:

- –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ç—å/VPN
- –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–∞–ª—å–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω (session/token –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç)
- –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `API_BASE_URL` —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –¥–æ—Å—Ç—É–ø–Ω—ã–π backend –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
