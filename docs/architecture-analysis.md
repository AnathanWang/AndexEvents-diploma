# Andex Events - –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –∏ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–û–±–∑–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞](#–æ–±–∑–æ—Ä-–ø—Ä–æ–µ–∫—Ç–∞)
2. [–ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö](#–º–æ–¥–µ–ª—å-–¥–∞–Ω–Ω—ã—Ö)
3. [–°–∏—Å—Ç–µ–º–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π](#—Å–∏—Å—Ç–µ–º–∞-—Ö—Ä–∞–Ω–µ–Ω–∏—è-–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π)
4. [–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è](#–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è-–∏-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è)
5. [Backend –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#backend-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
6. [Frontend –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#frontend-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
7. [–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –∏ –∫–∞—Ä—Ç—ã](#–≥–µ–æ–ª–æ–∫–∞—Ü–∏—è-–∏-–∫–∞—Ä—Ç—ã)
8. [–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å](#–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
9. [–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é](#—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏-–ø–æ-—É–ª—É—á—à–µ–Ω–∏—é)

---

## –û–±–∑–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞

**Andex Events** ‚Äî —ç—Ç–æ –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–æ–±—ã—Ç–∏–π –∏ –∑–Ω–∞–∫–æ–º—Å—Ç–≤ —Å –µ–¥–∏–Ω–æ–º—ã—à–ª–µ–Ω–Ω–∏–∫–∞–º–∏, –ø–æ—Å—Ç—Ä–æ–µ–Ω–Ω–æ–µ –Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º tech stack.

### –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

#### Frontend (Mobile)
- **Flutter** 3.9.2+ / Dart 3.9.2+
- **State Management**: BLoC (flutter_bloc ^8.1.6)
- **UI Framework**: Material Design 3
- **–ö–∞—Ä—Ç—ã**: Yandex MapKit 4.1.0
- **–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è**: geolocator ^13.0.1
- **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**: Supabase Flutter ^2.6.0
- **HTTP –∫–ª–∏–µ–Ω—Ç**: Dio ^5.7.0
- **–•—Ä–∞–Ω–µ–Ω–∏–µ**: shared_preferences, flutter_secure_storage

#### Backend (API)
- **Runtime**: Node.js + TypeScript
- **Framework**: Express.js 5.1.0
- **ORM**: Prisma 6.19.0
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: PostgreSQL + PostGIS —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
- **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**: JWT (jsonwebtoken ^9.0.2)
- **–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤**: Multer ^1.4.5
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π**: Sharp ^0.33.5
- **–í–∞–ª–∏–¥–∞—Ü–∏—è**: Zod ^4.1.12
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: Winston ^3.15.0

#### –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ Storage
- **Supabase** (Auth + Storage)
  - URL: `https://rykbewslbfxltmipyseg.supabase.co`
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è OAuth –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ –∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

---

## –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö

### Prisma Schema

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **Prisma ORM** —Å PostgreSQL –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º PostGIS –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≥–µ–æ–¥–∞–Ω–Ω—ã–º–∏.

```prisma
datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [postgis]
}

generator client {
  provider        = "prisma-client-js"
  output          = "../src/generated/prisma"
  previewFeatures = ["postgresqlExtensions"]
}
```

### –û—Å–Ω–æ–≤–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏

#### 1. User (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)

```typescript
model User {
  id            String   @id @default(uuid())
  supabaseUid   String   @unique        // ID –∏–∑ Supabase Auth
  email         String   @unique
  displayName   String?
  photoUrl      String?
  bio           String?
  interests     String[]                // –ú–∞—Å—Å–∏–≤ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤
  socialLinks   Json?                   // {instagram, telegram, etc}
  age           Int?
  gender        String?
  role          UserRole @default(USER) // USER | MODERATOR | ADMIN
  
  // –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è
  lastLatitude  Float?
  lastLongitude Float?
  lastLocationUpdate DateTime?
  
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏
  isProfileVisible   Boolean @default(true)
  isLocationVisible  Boolean @default(true)
  minAge             Int?
  maxAge             Int?
  maxDistance        Int @default(50000)  // –í –º–µ—Ç—Ä–∞—Ö
  
  // FCM —Ç–æ–∫–µ–Ω –¥–ª—è push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  fcmToken      String?
  
  // –û–Ω–±–æ—Ä–¥–∏–Ω–≥
  isOnboardingCompleted Boolean @default(false)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // –û—Ç–Ω–æ—à–µ–Ω–∏—è
  createdEvents         Event[] @relation("EventCreator")
  participations        Participant[]
  matchesAsUserA        Match[] @relation("MatchUserA")
  matchesAsUserB        Match[] @relation("MatchUserB")
  sentNotifications     Notification[] @relation("NotificationSender")
  receivedNotifications Notification[] @relation("NotificationReceiver")
}
```

**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –º–æ–¥–µ–ª–∏ User:**

- **supabaseUid**: –°–≤—è–∑—å —Å —Å–∏—Å—Ç–µ–º–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ Supabase
- **interests**: –ú–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –º–∞—Ç—á–∏–Ω–≥–∞ –ø–æ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º
- **socialLinks**: JSON –ø–æ–ª–µ –¥–ª—è –≥–∏–±–∫–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π
- **–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è**: –•—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ –±–ª–∏–∂–∞–π—à–∏—Ö —Å–æ–±—ã—Ç–∏–π –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏**: –ö–æ–Ω—Ç—Ä–æ–ª—å –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø—Ä–æ—Ñ–∏–ª—è –∏ –ª–æ–∫–∞—Ü–∏–∏
- **–í–æ–∑—Ä–∞—Å—Ç–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã**: minAge/maxAge –¥–ª—è –º–∞—Ç—á–∏–Ω–≥–∞
- **maxDistance**: –†–∞–¥–∏—É—Å –ø–æ–∏—Å–∫–∞ –≤ –º–µ—Ç—Ä–∞—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 50 –∫–º)

#### 2. Event (–°–æ–±—ã—Ç–∏–µ)

```typescript
model Event {
  id          String   @id @default(uuid())
  title       String
  description String   @db.Text
  category    String
  
  // –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è —Å PostGIS
  location    String   // –ê–¥—Ä–µ—Å (—Ç–µ–∫—Å—Ç–æ–≤—ã–π)
  latitude    Float
  longitude   Float
  locationGeo Unsupported("geography(Point, 4326)")? // PostGIS —Ç–æ—á–∫–∞
  
  dateTime    DateTime
  endDateTime DateTime?
  price       Float    @default(0)
  imageUrl    String?
  isOnline    Boolean  @default(false)
  
  // –ú–æ–¥–µ—Ä–∞—Ü–∏—è
  status      EventStatus @default(PENDING)  // PENDING | APPROVED | REJECTED
  rejectionReason String?
  
  // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
  maxParticipants Int?
  minAge      Int?
  maxAge      Int?
  
  createdById String?
  createdBy   User? @relation("EventCreator", fields: [createdById], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  participants Participant[]
}
```

**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –º–æ–¥–µ–ª–∏ Event:**

- **PostGIS Geography**: –ü–æ–ª–µ `locationGeo` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–∏–ø `geography(Point, 4326)` –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã—Ö –≥–µ–æ–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- **–ú–æ–¥–µ—Ä–∞—Ü–∏—è**: –¢—Ä—ë—Ö—Å—Ç—É–ø–µ–Ω—á–∞—Ç—ã–π —Å—Ç–∞—Ç—É—Å (PENDING ‚Üí APPROVED/REJECTED)
- **–ì–∏–±–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è**: –ú–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π/–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç, –ª–∏–º–∏—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- **–û–Ω–ª–∞–π–Ω —Å–æ–±—ã—Ç–∏—è**: –§–ª–∞–≥ `isOnline` –¥–ª—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π
- **–ö–∞—Å–∫–∞–¥–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ**: –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–¥–∞–ª—è—é—Ç—Å—è –µ–≥–æ —Å–æ–±—ã—Ç–∏—è

#### 3. Participant (–£—á–∞—Å—Ç–Ω–∏–∫ —Å–æ–±—ã—Ç–∏—è)

```typescript
model Participant {
  id        String   @id @default(uuid())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  eventId   String
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  status    ParticipantStatus @default(INTERESTED)  // INTERESTED | GOING
  
  joinedAt  DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([userId, eventId])
  @@index([userId])
  @@index([eventId])
}
```

**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**

- **–£–Ω–∏–∫–∞–ª—å–Ω–∞—è —Å–≤—è–∑—å**: –ö–æ–º–ø–æ–∑–∏—Ç–Ω—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á `(userId, eventId)` ‚Äî –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ —Å–æ–±—ã—Ç–∏–∏ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
- **–°—Ç–∞—Ç—É—Å —É—á–∞—Å—Ç–∏—è**: INTERESTED (–∏–Ω—Ç–µ—Ä–µ—Å—É—é—Å—å) vs GOING (—Ç–æ—á–Ω–æ –∏–¥—É)
- **–ò–Ω–¥–µ–∫—Å—ã**: –î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏–ª–∏ —Å–æ–±—ã—Ç–∏—é

#### 4. Match (–ú–∞—Ç—á–∏–Ω–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)

```typescript
model Match {
  id        String   @id @default(uuid())
  
  userAId   String
  userA     User     @relation("MatchUserA", fields: [userAId], references: [id], onDelete: Cascade)
  
  userBId   String
  userB     User     @relation("MatchUserB", fields: [userBId], references: [id], onDelete: Cascade)
  
  userAAction MatchAction?  // LIKE | DISLIKE | SUPER_LIKE
  userBAction MatchAction?
  
  isMutual  Boolean  @default(false)
  matchedAt DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([userAId, userBId])
  @@index([userAId])
  @@index([userBId])
  @@index([isMutual])
}
```

**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**

- **–î–≤—É–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –º–∞—Ç—á–∏–Ω–≥**: –•—Ä–∞–Ω—è—Ç—Å—è –¥–µ–π—Å—Ç–≤–∏—è –æ–±–æ–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–¢–∏–ø—ã –¥–µ–π—Å—Ç–≤–∏–π**: LIKE, DISLIKE, SUPER_LIKE
- **–§–ª–∞–≥ isMutual**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –≤–∑–∞–∏–º–Ω–æ–º –ª–∞–π–∫–µ
- **Tinder-style –º–µ—Ö–∞–Ω–∏–∫–∞**: –°–≤–∞–π–ø –≤–ª–µ–≤–æ/–≤–ø—Ä–∞–≤–æ

#### 5. Notification (–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)

```typescript
model Notification {
  id          String   @id @default(uuid())
  
  type        String   // MATCH, EVENT_REMINDER, EVENT_APPROVED, etc.
  title       String
  body        String   @db.Text
  data        Json?    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
  
  senderId    String?
  sender      User?    @relation("NotificationSender", fields: [senderId], references: [id], onDelete: SetNull)
  
  receiverId  String
  receiver    User     @relation("NotificationReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  
  isRead      Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  
  @@index([receiverId])
  @@index([isRead])
  @@index([type])
}
```

**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**

- **–¢–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**: –†–∞–∑–ª–∏—á–Ω—ã–µ —Ç–∏–ø—ã (–º–∞—Ç—á–∏, –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è, –æ–¥–æ–±—Ä–µ–Ω–∏—è)
- **JSON –¥–∞–Ω–Ω—ã–µ**: –ì–∏–±–∫–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
- **–°—Ç–∞—Ç—É—Å –ø—Ä–æ—á—Ç–µ–Ω–∏—è**: –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- **–ò–Ω–¥–µ–∫—Å—ã**: –î–ª—è –±—ã—Å—Ç—Ä–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—é, —Å—Ç–∞—Ç—É—Å—É –∏ —Ç–∏–ø—É

### Enums

```typescript
enum UserRole {
  USER
  MODERATOR
  ADMIN
}

enum EventStatus {
  PENDING    // –û–∂–∏–¥–∞–µ—Ç –º–æ–¥–µ—Ä–∞—Ü–∏–∏
  APPROVED   // –û–¥–æ–±—Ä–µ–Ω–æ
  REJECTED   // –û—Ç–∫–ª–æ–Ω–µ–Ω–æ
}

enum MatchAction {
  LIKE
  DISLIKE
  SUPER_LIKE
}

enum ParticipantStatus {
  INTERESTED  // –ò–Ω—Ç–µ—Ä–µ—Å—É—é—Å—å
  GOING       // –¢–æ—á–Ω–æ –ø–æ–π–¥—É
}
```

### –ò–Ω–¥–µ–∫—Å—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤:

**User:**
- `supabaseUid` (unique)
- `email` (unique)

**Event:**
- `createdById`
- `status`
- `dateTime`
- `category`

**Participant:**
- `userId`
- `eventId`
- –ö–æ–º–ø–æ–∑–∏—Ç–Ω—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å `(userId, eventId)`

**Match:**
- `userAId`
- `userBId`
- `isMutual`
- –ö–æ–º–ø–æ–∑–∏—Ç–Ω—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å `(userAId, userBId)`

**Notification:**
- `receiverId`
- `isRead`
- `type`

---

## –°–∏—Å—Ç–µ–º–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥** –∫ —Ö—Ä–∞–Ω–µ–Ω–∏—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:

### 1. Supabase Storage (–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –≤–∞—Ä–∏–∞–Ω—Ç)

#### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∫–µ—Ç–æ–≤

```
Supabase Storage
‚îú‚îÄ‚îÄ avatars/        (Public bucket)
‚îÇ   ‚îî‚îÄ‚îÄ {userId}/{timestamp}.jpg
‚îî‚îÄ‚îÄ events/         (Public bucket)
    ‚îî‚îÄ‚îÄ {userId}/{timestamp}.jpg
```

#### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

**–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–∫–µ—Ç–æ–≤:**
- **–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞**: Public (–∞–Ω–æ–Ω–∏–º–Ω–æ–µ —á—Ç–µ–Ω–∏–µ)
- **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä**: 
  - –ê–≤–∞—Ç–∞—Ä—ã: 5 MB
  - –°–æ–±—ã—Ç–∏—è: 10 MB
- **–†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã**: JPEG, PNG, GIF, WebP

#### –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏ (Flutter)

```dart
// lib/data/services/upload_service.dart
class ProgressUploadService {
  Future<String> uploadProfilePhoto(String filePath) async {
    // 1. –°–∂–∞—Ç–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    final compressedFile = await ImageUtils.compressImage(originalFile);
    
    // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞
    final fileSize = await compressedFile.length();
    if (fileSize > 5 * 1024 * 1024) {
      throw Exception('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π');
    }
    
    // 3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∏–º–µ–Ω–∏
    final fileName = DateTime.now().millisecondsSinceEpoch.toString();
    final path = 'avatars/$fileName';
    
    // 4. –ó–∞–≥—Ä—É–∑–∫–∞ –≤ Supabase Storage
    await _supabase.storage.from('avatars').uploadBinary(
      path,
      fileBytes,
      fileOptions: const FileOptions(
        cacheControl: '3600',
        contentType: 'image/jpeg',
        upsert: true,
      ),
    );
    
    // 5. –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—É–±–ª–∏—á–Ω–æ–≥–æ URL
    final url = _supabase.storage.from('avatars').getPublicUrl(path);
    return url;
  }
}
```

#### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

```dart
// lib/core/utils/image_utils.dart
class ImageUtils {
  static Future<File> compressImage(File file) async {
    final result = await FlutterImageCompress.compressAndGetFile(
      file.absolute.path,
      targetPath,
      quality: 70,              // 70% –∫–∞—á–µ—Å—Ç–≤–æ
      minWidth: 512,            // –ú–∏–Ω–∏–º—É–º 512px
      minHeight: 512,
      format: CompressFormat.jpeg,
    );
    return result;
  }
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∂–∞—Ç–∏—è:**
- –û—Ä–∏–≥–∏–Ω–∞–ª: 2-5 MB
- –ü–æ—Å–ª–µ —Å–∂–∞—Ç–∏—è: 200-800 KB (—Å–æ–±—ã—Ç–∏—è), 100-300 KB (–∞–≤–∞—Ç–∞—Ä—ã)

### 2. –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç)

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: `docs/local-storage-guide.md`

#### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π

```
App Documents Directory
‚îî‚îÄ‚îÄ storage/
    ‚îú‚îÄ‚îÄ avatars/
    ‚îÇ   ‚îú‚îÄ‚îÄ 1702390123456.jpg
    ‚îÇ   ‚îî‚îÄ‚îÄ 1702390124567.jpg
    ‚îî‚îÄ‚îÄ events/
        ‚îú‚îÄ‚îÄ 1702390126789.jpg
        ‚îî‚îÄ‚îÄ 1702390127890.jpg
```

#### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏

**‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ù–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
- –ë—ã—Å—Ç—Ä–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ —Ñ–æ—Ç–æ
- –ù–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ —Ñ–∞–π–ª–∞–º–∏

**‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- –ù–µ—Ç –æ–±–ª–∞—á–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞
- –ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- –ù–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏
- –ë–æ–ª—å—à–µ –ø–∞–º—è—Ç–∏ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ

### 3. Backend –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (Node.js)

Backend —Ç–∞–∫–∂–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä.

#### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

```
backend/public/uploads/
‚îú‚îÄ‚îÄ avatars/
‚îÇ   ‚îî‚îÄ‚îÄ {userId}/
‚îÇ       ‚îî‚îÄ‚îÄ {timestamp}-{random}.jpg
‚îî‚îÄ‚îÄ events/
    ‚îî‚îÄ‚îÄ {userId}/
        ‚îî‚îÄ‚îÄ {timestamp}-{random}.jpg
```

#### Middleware –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏

```typescript
// backend/src/routes/upload.routes.ts
const storage = multer.diskStorage({
  destination: function (req, file, cb) {
    const bucket = req.query.bucket || 'events';
    const userId = req.user?.userId;
    const uploadDir = path.join(process.cwd(), `public/uploads/${bucket}/${userId}`);
    
    // –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
    if (!fs.existsSync(uploadDir)) {
      fs.mkdirSync(uploadDir, { recursive: true });
    }
    
    cb(null, uploadDir);
  },
  filename: function (req, file, cb) {
    const uniqueSuffix = Date.now() + '-' + crypto.randomBytes(4).toString('hex');
    const ext = path.extname(file.originalname).toLowerCase() || '.jpg';
    cb(null, `${uniqueSuffix}${ext}`);
  }
});

const upload = multer({
  storage: storage,
  limits: { fileSize: 10 * 1024 * 1024 },  // 10MB
  fileFilter: (req, file, cb) => {
    // –í–∞–ª–∏–¥–∞—Ü–∏—è MIME type –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
    const isValidImage = file.mimetype.startsWith('image/');
    const validExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp'];
    const ext = path.extname(file.originalname).toLowerCase();
    
    if (isValidImage && validExtensions.includes(ext)) {
      cb(null, true);
    } else {
      cb(new Error('Invalid file type'));
    }
  }
});
```

#### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤

**1. –í–∞–ª–∏–¥–∞—Ü–∏—è MIME type**
```typescript
const ALLOWED_MIME_TYPES = new Set([
  'image/jpeg',
  'image/jpg',
  'image/png',
  'image/webp',
  'image/gif',
]);
```

**2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞–≥–∏—á–µ—Å–∫–∏—Ö —á–∏—Å–µ–ª (File Signatures)**
```typescript
const FILE_SIGNATURES = {
  jpeg: Buffer.from([0xFF, 0xD8, 0xFF]),
  png: Buffer.from([0x89, 0x50, 0x4E, 0x47]),
  gif: Buffer.from([0x47, 0x49, 0x46]),
  webp: Buffer.from([0x52, 0x49, 0x46, 0x46])
};

function validateFileSignature(buffer: Buffer, mimeType: string): boolean {
  if (mimeType === 'image/jpeg') {
    return buffer.subarray(0, 3).equals(FILE_SIGNATURES.jpeg);
  }
  // ... –¥—Ä—É–≥–∏–µ —Ç–∏–ø—ã
}
```

**3. –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ (Path Traversal –∑–∞—â–∏—Ç–∞)**
```typescript
function sanitizeFilename(filename: string): string {
  return filename
    .replaceAll('..', '')           // –£–¥–∞–ª—è–µ–º ..
    .replaceAll(/[/\\]/g, '')       // –£–¥–∞–ª—è–µ–º —Å–ª—ç—à–∏
    .replaceAll(/[^\w\s.-]/g, '')   // –¢–æ–ª—å–∫–æ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
    .trim();
}
```

**4. Middleware –∑–∞—â–∏—Ç—ã –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º**
```typescript
// backend/src/middleware/file-access.middleware.ts
export const fileAccessMiddleware = (req, res, next) => {
  // GET –∑–∞–ø—Ä–æ—Å—ã - —Ä–∞–∑—Ä–µ—à–∞–µ–º –≤—Å–µ–º (–ø—É–±–ª–∏—á–Ω—ã–µ —Ñ–∞–π–ª—ã)
  if (req.method === 'GET') {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ Path Traversal
    if (req.path.includes('..') || req.path.includes('//')) {
      return res.status(400).json({ message: 'Invalid file path' });
    }
    return next();
  }

  // POST/PUT/DELETE - —Ç—Ä–µ–±—É—é—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  const authenticatedUserId = req.user?.userId;
  if (!authenticatedUserId) {
    return res.status(401).json({ message: 'Unauthorized' });
  }

  // –ò–∑–≤–ª–µ–∫–∞–µ–º userId –∏–∑ –ø—É—Ç–∏: /uploads/{bucket}/{userId}/{filename}
  const parts = req.path.split('/').filter(Boolean);
  const [bucket, fileUserId] = parts;
  
  // –ë–ª–æ–∫–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø –∫ —á—É–∂–∏–º —Ñ–∞–π–ª–∞–º
  if (fileUserId !== authenticatedUserId) {
    logger.error('[FileAccess] –ù–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø', {
      authenticatedUserId,
      attemptedFileUserId: fileUserId,
    });
    return res.status(403).json({ message: 'Access denied' });
  }

  next();
};
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (Sharp)

Backend –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **Sharp** –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:

```typescript
import sharp from 'sharp';

// –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
await sharp(inputPath)
  .resize(1200, 1200, {
    fit: 'inside',
    withoutEnlargement: true
  })
  .jpeg({ quality: 80 })
  .toFile(outputPath);
```

### Rate Limiting –¥–ª—è –∑–∞–≥—Ä—É–∑–æ–∫

```typescript
const uploadLimiter = rateLimit({
  windowMs: 60 * 1000,  // 1 –º–∏–Ω—É—Ç–∞
  max: 10,              // –º–∞–∫—Å–∏–º—É–º 10 –∑–∞–≥—Ä—É–∑–æ–∫
  message: '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–≥—Ä—É–∑–æ–∫. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ.',
});

app.use('/api/upload', uploadLimiter, uploadRoutes);
```

---

## –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **Supabase Auth** + **JWT —Ç–æ–∫–µ–Ω—ã** –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Flutter App    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ 1. signIn()
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Supabase Auth  ‚îÇ ‚óÑ‚îÄ‚îÄ‚îÄ OAuth Providers (Google, Apple)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ 2. JWT Token
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Backend API   ‚îÇ
‚îÇ  (JWT Verify)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 1. Supabase Authentication

#### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞

```dart
// lib/main.dart
await Supabase.initialize(
  url: AppConfig.supabaseUrl,
  anonKey: AppConfig.supabaseAnonKey,
);
```

#### –ú–µ—Ç–æ–¥—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

**1. Email/Password —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è**
```dart
// lib/data/services/auth_service.dart
Future<AuthResponse> signUpWithEmail({
  required String email,
  required String password,
  required String displayName,
}) async {
  // –°–æ–∑–¥–∞—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Supabase
  final response = await _supabase.auth.signUp(
    email: email,
    password: password,
    data: {'display_name': displayName},
  );
  
  // –°–æ–∑–¥–∞—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –Ω–∞—à–µ–π –ë–î
  if (response.user != null) {
    await _createUserInBackend(
      supabaseUid: response.user!.id,
      email: email,
      displayName: displayName,
    );
  }
  
  return response;
}
```

**2. Email/Password –≤—Ö–æ–¥**
```dart
Future<AuthResponse> signInWithEmail({
  required String email,
  required String password,
}) async {
  return await _supabase.auth.signInWithPassword(
    email: email,
    password: password,
  );
}
```

**3. Google Sign-In**
```dart
Future<Map<String, dynamic>> signInWithGoogleAndGetStatus() async {
  // 1. –ü–æ–ª—É—á–∞–µ–º Google –∞–∫–∫–∞—É–Ω—Ç
  final GoogleSignInAccount? googleUser = await _googleSignIn.signIn();
  
  // 2. –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω—ã
  final GoogleSignInAuthentication googleAuth = await googleUser.authentication;
  
  // 3. –í—Ö–æ–¥–∏–º –≤ Supabase —Å Google —Ç–æ–∫–µ–Ω–∞–º–∏
  final AuthResponse response = await _supabase.auth.signInWithIdToken(
    provider: OAuthProvider.google,
    idToken: googleAuth.idToken!,
    accessToken: googleAuth.accessToken,
  );
  
  // 4. –°–æ–∑–¥–∞—ë–º/–æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ backend
  await _createUserInBackend(
    supabaseUid: response.user!.id,
    email: response.user!.email!,
    displayName: response.user!.userMetadata?['full_name'],
    photoUrl: response.user!.userMetadata?['avatar_url'],
  );
  
  return {
    'userCredential': response,
    'isOnboardingCompleted': await _getOnboardingStatus(),
  };
}
```

**4. Apple Sign-In**
–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ Google, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É—è `OAuthProvider.apple`.

#### –ü–æ–ª—É—á–µ–Ω–∏–µ JWT —Ç–æ–∫–µ–Ω–∞

```dart
Future<String?> getIdToken() async {
  return _supabase.auth.currentSession?.accessToken;
}
```

### 2. Backend JWT Verification

#### Auth Middleware

```typescript
// backend/src/middleware/auth.middleware.ts
export const authMiddleware = async (req, res, next) => {
  try {
    const authHeader = req.headers.authorization;
    
    if (!authHeader?.startsWith('Bearer ')) {
      return res.status(401).json({ message: 'No token provided' });
    }
    
    const token = authHeader.split('Bearer ')[1];
    
    // –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ–º JWT —Ç–æ–∫–µ–Ω –æ—Ç Supabase
    const jwtSecret = process.env.SUPABASE_JWT_SECRET;
    const decoded = jwt.verify(token, jwtSecret) as JwtPayload;
    
    // –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î –ø–æ supabaseUid
    const user = await prisma.user.findUnique({
      where: { supabaseUid: decoded.sub }
    });
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ request
    req.user = {
      uid: decoded.sub!,
      userId: user?.id,
      email: decoded.email,
    };
    
    next();
  } catch (error) {
    res.status(401).json({ message: 'Invalid token' });
  }
};
```

#### –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

```typescript
export const optionalAuthMiddleware = async (req, res, next) => {
  // –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ authMiddleware, –Ω–æ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Ç–æ–∫–µ–Ω–∞
  try {
    // ... –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ ...
    req.user = { /* ... */ };
  } catch (error) {
    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
  }
  next();
};
```

### 3. –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Backend

–ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Supabase —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π –ë–î:

```typescript
// backend/src/controllers/user.controller.ts
export async function createUser(req, res) {
  const { supabaseUid, email, displayName, photoUrl } = req.body;
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
  const existingUser = await prisma.user.findUnique({
    where: { email }
  });
  
  if (existingUser) {
    if (!existingUser.supabaseUid) {
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      return await prisma.user.update({
        where: { id: existingUser.id },
        data: { supabaseUid }
      });
    }
    throw new Error('User with this email already exists');
  }
  
  // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const newUser = await prisma.user.create({
    data: {
      supabaseUid,
      email,
      displayName: displayName || '',
      photoUrl: photoUrl || '',
    }
  });
  
  // –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫–∏ –¥–ª—è —Ñ–∞–π–ª–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  createUserStorageFolders(newUser.id);
  
  return newUser;
}
```

### 4. –ó–∞—â–∏—Ç–∞ API endpoints

```typescript
// backend/src/routes/user.routes.ts
const router = Router();

// –ü—É–±–ª–∏—á–Ω—ã–π endpoint
router.post('/', createUser);

// –ó–∞—â–∏—â—ë–Ω–Ω—ã–µ endpoints
router.get('/me', authMiddleware, getCurrentUser);
router.put('/me', authMiddleware, updateProfile);
router.put('/me/location', authMiddleware, updateLocation);
router.get('/matches', authMiddleware, getMatches);
```

### 5. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

```dart
// lib/data/services/auth_service.dart
String _handleSupabaseAuthException(AuthException e) {
  final message = e.message.toLowerCase();
  
  if (message.contains('invalid') && message.contains('email')) {
    return '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email';
  }
  if (message.contains('user already registered')) {
    return '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω';
  }
  if (message.contains('invalid login credentials')) {
    return '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
  }
  if (message.contains('email not confirmed')) {
    return 'Email –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É';
  }
  
  return '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${e.message}';
}
```

### 6. –û–Ω–±–æ—Ä–¥–∏–Ω–≥ –∏ —Å—Ç–∞—Ç—É—Å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

```dart
Future<Map<String, dynamic>> signInWithGoogleAndGetStatus() async {
  // ... –≤—Ö–æ–¥ —á–µ—Ä–µ–∑ Google ...
  
  // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞ –∏–∑ backend
  bool isOnboardingCompleted = false;
  try {
    final profileData = await getCurrentUserProfile();
    isOnboardingCompleted = profileData['isOnboardingCompleted'] ?? false;
  } catch (e) {
    isOnboardingCompleted = false;
  }
  
  return {
    'userCredential': response,
    'isOnboardingCompleted': isOnboardingCompleted,
  };
}
```

### 7. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞

```typescript
// backend/src/controllers/user.controller.ts
export async function updateProfile(req, res) {
  const userId = req.user?.userId;
  
  const {
    displayName,
    bio,
    age,
    gender,
    interests,
    socialLinks,
    isOnboardingCompleted  // ‚Üê –§–ª–∞–≥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞
  } = req.body;
  
  const updatedUser = await prisma.user.update({
    where: { id: userId },
    data: {
      displayName,
      bio,
      age,
      gender,
      interests,
      socialLinks,
      isOnboardingCompleted
    }
  });
  
  return res.json({ success: true, data: updatedUser });
}
```

### 8. –†–æ–ª–∏ –∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞

```typescript
enum UserRole {
  USER       // –û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
  MODERATOR  // –ú–æ–∂–µ—Ç –º–æ–¥–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è
  ADMIN      // –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø
}

// Middleware –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–∏
export const requireRole = (roles: UserRole[]) => {
  return async (req, res, next) => {
    const user = await prisma.user.findUnique({
      where: { id: req.user.userId }
    });
    
    if (!user || !roles.includes(user.role)) {
      return res.status(403).json({ message: 'Forbidden' });
    }
    
    next();
  };
};

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
router.put('/events/:id/approve', authMiddleware, requireRole(['MODERATOR', 'ADMIN']), approveEvent);
```

---

## Backend –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
backend/
‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îú‚îÄ‚îÄ schema.prisma           # Prisma —Å—Ö–µ–º–∞
‚îÇ   ‚îî‚îÄ‚îÄ migrations/             # –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ controllers/            # –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã (–±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ event.controller.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.controller.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ match.controller.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ upload.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ routes/                 # –ú–∞—Ä—à—Ä—É—Ç—ã API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ event.routes.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.routes.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ match.routes.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ upload.routes.ts
‚îÇ   ‚îú‚îÄ‚îÄ services/               # –°–µ—Ä–≤–∏—Å—ã (—Ä–∞–±–æ—Ç–∞ —Å –ë–î)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ event.service.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.service.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ match.service.ts
‚îÇ   ‚îú‚îÄ‚îÄ middleware/             # Middleware
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.middleware.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ file-access.middleware.ts
‚îÇ   ‚îú‚îÄ‚îÄ utils/                  # –£—Ç–∏–ª–∏—Ç—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logger.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ prisma.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ geocoding.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ user-storage.ts
‚îÇ   ‚îî‚îÄ‚îÄ index.ts                # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îú‚îÄ‚îÄ public/
‚îÇ   ‚îî‚îÄ‚îÄ uploads/                # –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
‚îÇ       ‚îú‚îÄ‚îÄ avatars/
‚îÇ       ‚îî‚îÄ‚îÄ events/
‚îú‚îÄ‚îÄ package.json
‚îî‚îÄ‚îÄ tsconfig.json
```

### –°–ª–æ–∏—Å—Ç–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         HTTP Request                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         Middleware Layer            ‚îÇ
‚îÇ  - Authentication                   ‚îÇ
‚îÇ  - Rate Limiting                    ‚îÇ
‚îÇ  - Logging                          ‚îÇ
‚îÇ  - File Access Control              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         Routes Layer                ‚îÇ
‚îÇ  - URL Mapping                      ‚îÇ
‚îÇ  - Request Validation               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ       Controllers Layer             ‚îÇ
‚îÇ  - Request/Response handling        ‚îÇ
‚îÇ  - Input validation                 ‚îÇ
‚îÇ  - Error handling                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ        Services Layer               ‚îÇ
‚îÇ  - Business logic                   ‚îÇ
‚îÇ  - Database operations (Prisma)     ‚îÇ
‚îÇ  - External API calls               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ       Database (PostgreSQL)         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### 1. Express Server

```typescript
// src/index.ts
const app = express();

// Security middleware
app.use(helmet());
app.use(cors());

// Body parsing
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));

// Logging
app.use(morgan('combined', {
  stream: { write: (message) => logger.info(message.trim()) }
}));

// Rate limiting
const generalLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,  // 15 –º–∏–Ω—É—Ç
  max: 100,                   // 100 –∑–∞–ø—Ä–æ—Å–æ–≤
});
app.use(generalLimiter);

// Routes
app.use('/api/events', eventRoutes);
app.use('/api/users', userRoutes);
app.use('/api/matches', matchRoutes);
app.use('/api/upload', uploadLimiter, uploadRoutes);

// Static files
app.use('/uploads', fileAccessMiddleware);
app.use('/uploads', express.static(path.join(process.cwd(), 'public/uploads')));
```

#### 2. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (Winston)

```typescript
// src/utils/logger.ts
import winston from 'winston';

const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.json()
  ),
  transports: [
    new winston.transports.File({ filename: 'logs/error.log', level: 'error' }),
    new winston.transports.File({ filename: 'logs/combined.log' }),
  ],
});

if (process.env.NODE_ENV !== 'production') {
  logger.add(new winston.transports.Console({
    format: winston.format.simple()
  }));
}
```

#### 3. Rate Limiting

```typescript
// src/index.ts
const authLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,  // 15 –º–∏–Ω—É—Ç
  max: 5,                     // 5 –ø–æ–ø—ã—Ç–æ–∫
  message: '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.',
});

const uploadLimiter = rateLimit({
  windowMs: 60 * 1000,  // 1 –º–∏–Ω—É—Ç–∞
  max: 10,              // 10 –∑–∞–≥—Ä—É–∑–æ–∫
  message: '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–≥—Ä—É–∑–æ–∫. –ü–æ–¥–æ–∂–¥–∏—Ç–µ.',
});

app.use('/api/users/login', authLimiter);
app.use('/api/upload', uploadLimiter, uploadRoutes);
```

---

## –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –∏ –∫–∞—Ä—Ç—ã

### PostGIS –¥–ª—è –≥–µ–æ–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **PostGIS —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ** PostgreSQL –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –≥–µ–æ–¥–∞–Ω–Ω—ã–º–∏.

#### 1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≥–µ–æ–¥–∞–Ω–Ω—ã—Ö

```prisma
model Event {
  // –û–±—ã—á–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
  latitude    Float
  longitude   Float
  
  // PostGIS Geography –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
  locationGeo Unsupported("geography(Point, 4326)")?
}

model User {
  lastLatitude  Float?
  lastLongitude Float?
  lastLocationUpdate DateTime?
}
```

**SRID 4326** = WGS84 (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç GPS)

#### 2. –°–æ–∑–¥–∞–Ω–∏–µ –≥–µ–æ—Ç–æ—á–∫–∏ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å–æ–±—ã—Ç–∏—è

```typescript
// backend/src/services/event.service.ts
async createEvent(data: CreateEventInput) {
  const result = await prisma.$queryRaw<[{ id: string }]>`
    INSERT INTO "Event" (
      id, title, description, category, location,
      latitude, longitude, "locationGeo",
      "dateTime", price, "imageUrl", "isOnline",
      status, "createdById", "createdAt", "updatedAt"
    ) VALUES (
      gen_random_uuid()::text,
      ${data.title},
      ${data.description},
      ${data.category},
      ${data.location},
      ${data.latitude},
      ${data.longitude},
      ST_SetSRID(ST_MakePoint(${data.longitude}, ${data.latitude}), 4326)::geography,
      ${data.dateTime},
      ${data.price ?? 0},
      ${data.imageUrl ?? null},
      ${data.isOnline ?? false},
      'APPROVED'::"EventStatus",
      ${createdById ?? null},
      NOW(),
      NOW()
    )
    RETURNING id
  `;
  
  return await prisma.event.findUnique({ where: { id: result[0].id } });
}
```

**–í–∞–∂–Ω–æ:** Longitude (–¥–æ–ª–≥–æ—Ç–∞) –∏–¥—ë—Ç –ø–µ—Ä–≤–æ–π –≤ `ST_MakePoint(lon, lat)`

#### 3. –ü–æ–∏—Å–∫ —Å–æ–±—ã—Ç–∏–π –≤ —Ä–∞–¥–∏—É—Å–µ (ST_DWithin)

```typescript
// backend/src/services/event.service.ts
async getNearbyEvents(
  userLat: number,
  userLon: number,
  maxDistance: number = 50000,  // –º–µ—Ç—Ä—ã
  category?: string,
  page: number = 1,
  limit: number = 20
) {
  const offset = (page - 1) * limit;
  
  const events = await prisma.$queryRaw<any[]>`
    SELECT
      e.*,
      ST_Distance(
        e."locationGeo",
        ST_SetSRID(ST_MakePoint(${userLon}, ${userLat}), 4326)::geography
      ) as distance,
      json_build_object(
        'id', u.id,
        'displayName', u."displayName",
        'photoUrl', u."photoUrl"
      ) as "createdBy",
      COUNT(p.id) as "participantCount"
    FROM "Event" e
    LEFT JOIN "User" u ON e."createdById" = u.id
    LEFT JOIN "Participant" p ON e.id = p."eventId"
    WHERE
      e.status = 'APPROVED'
      AND e."isOnline" = false
      AND ST_DWithin(
        e."locationGeo",
        ST_SetSRID(ST_MakePoint(${userLon}, ${userLat}), 4326)::geography,
        ${maxDistance}
      )
      ${category ? prisma.$queryRaw`AND e.category = ${category}` : prisma.$queryRaw``}
    GROUP BY e.id, u.id
    ORDER BY distance ASC
    LIMIT ${limit}
    OFFSET ${offset}
  `;
  
  return events;
}
```

**ST_DWithin** ‚Äî –≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤ –≤ —Ä–∞–¥–∏—É—Å–µ:
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã
- –ì–æ—Ä–∞–∑–¥–æ –±—ã—Å—Ç—Ä–µ–µ, —á–µ–º –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏
- –†–∞–±–æ—Ç–∞–µ—Ç —Å –º–µ—Ç—Ä–∞–º–∏ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ `geography` —Ç–∏–ø–∞

#### 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```typescript
// backend/src/services/user.service.ts
export const updateUserLocation = async (
  userId: string,
  latitude: number,
  longitude: number
): Promise<void> => {
  // –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
  if (latitude < -90 || latitude > 90 || longitude < -180 || longitude > 180) {
    throw new Error('Invalid coordinates');
  }
  
  await prisma.user.update({
    where: { id: userId },
    data: {
      lastLatitude: latitude,
      lastLongitude: longitude,
      lastLocationUpdate: new Date(),
    },
  });
};
```

#### 5. –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –º–∞—Ç—á–∏–Ω–≥–∞

```typescript
// backend/src/services/user.service.ts
export const getMatchesForUser = async (
  userId: string,
  latitude?: number,
  longitude?: number,
  radiusKm: number = 50,
  limit: number = 20
): Promise<User[]> => {
  const currentUser = await prisma.user.findUnique({ where: { id: userId } });
  
  const userLat = latitude ?? currentUser.lastLatitude;
  const userLon = longitude ?? currentUser.lastLongitude;
  
  if (!userLat || !userLon) {
    return [];
  }
  
  // –í—ã—á–∏—Å–ª—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –ø–æ–∏—Å–∫–∞ (–ø—Ä–∏–±–ª–∏–∂—ë–Ω–Ω–æ)
  const earthRadiusKm = 6371;
  const latChange = (radiusKm / earthRadiusKm) * (180 / Math.PI);
  const lonChange = (radiusKm / (earthRadiusKm * Math.cos((userLat * Math.PI) / 180))) * (180 / Math.PI);
  
  const minLat = userLat - latChange;
  const maxLat = userLat + latChange;
  const minLon = userLon - lonChange;
  const maxLon = userLon + lonChange;
  
  let query: any = {
    where: {
      AND: [
        { id: { not: userId } },
        { isOnboardingCompleted: true },
        { isProfileVisible: true },
        { lastLatitude: { gte: minLat, lte: maxLat } },
        { lastLongitude: { gte: minLon, lte: maxLon } },
      ],
    },
    take: limit,
  };
  
  // –í–æ–∑—Ä–∞—Å—Ç–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
  if (currentUser.minAge || currentUser.maxAge) {
    const ageFilter: any = {};
    if (currentUser.minAge) ageFilter.gte = currentUser.minAge;
    if (currentUser.maxAge) ageFilter.lte = currentUser.maxAge;
    query.where.AND.push({ age: ageFilter });
  }
  
  return await prisma.user.findMany(query);
};
```

### Yandex MapKit (Flutter)

#### 1. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```dart
// lib/config/map_config.dart
class MapConfig {
  static const String apiKey = String.fromEnvironment('YANDEX_MAPKIT_API_KEY');
  
  static const Point defaultLocation = Point(
    latitude: 55.751244,   // –ú–æ—Å–∫–≤–∞
    longitude: 37.618423,
  );
}
```

#### 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã

```dart
// lib/presentation/events/map_view.dart
class MapView extends StatefulWidget {
  @override
  _MapViewState createState() => _MapViewState();
}

class _MapViewState extends State<MapView> {
  late YandexMapController _mapController;
  
  @override
  Widget build(BuildContext context) {
    return YandexMap(
      onMapCreated: (controller) {
        _mapController = controller;
      },
      mapObjects: _buildPlacemarks(events),
      onCameraPositionChanged: (position, reason, finished) {
        if (finished) {
          _loadEventsInVisibleArea(position);
        }
      },
    );
  }
  
  List<MapObject> _buildPlacemarks(List<EventModel> events) {
    return events.map((event) {
      return PlacemarkMapObject(
        mapId: MapObjectId(event.id),
        point: Point(latitude: event.latitude, longitude: event.longitude),
        icon: PlacemarkIcon.single(
          PlacemarkIconStyle(
            image: BitmapDescriptor.fromAssetImage('assets/icons/event_pin.png'),
            scale: 0.5,
          ),
        ),
        onTap: (placemark, point) => _showEventDetails(event),
      );
    }).toList();
  }
}
```

#### 3. –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –ª–æ–∫–∞—Ü–∏–∏

```dart
// lib/data/services/location_service.dart
import 'package:geolocator/geolocator.dart';

class LocationService {
  Future<Position?> getCurrentLocation() async {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
    LocationPermission permission = await Geolocator.checkPermission();
    if (permission == LocationPermission.denied) {
      permission = await Geolocator.requestPermission();
    }
    
    if (permission == LocationPermission.deniedForever) {
      return null;
    }
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
    return await Geolocator.getCurrentPosition(
      desiredAccuracy: LocationAccuracy.high,
    );
  }
  
  Stream<Position> getLocationStream() {
    return Geolocator.getPositionStream(
      locationSettings: LocationSettings(
        accuracy: LocationAccuracy.high,
        distanceFilter: 100,  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 100 –º–µ—Ç—Ä–æ–≤
      ),
    );
  }
}
```

#### 4. Geocoding (–∞–¥—Ä–µ—Å ‚Üí –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã)

```dart
// lib/data/services/geocoding_service.dart
import 'package:yandex_geocoder/yandex_geocoder.dart';

class GeocodingService {
  final YandexGeocoder _geocoder = YandexGeocoder(apiKey: MapConfig.apiKey);
  
  Future<GeocodeResponse?> getCoordinatesFromAddress(String address) async {
    try {
      final response = await _geocoder.getGeocode(GeocodeRequest(
        geocode: address,
        lang: Lang.ru,
      ));
      return response;
    } catch (e) {
      print('Geocoding error: $e');
      return null;
    }
  }
  
  Future<String?> getAddressFromCoordinates(double lat, double lon) async {
    try {
      final response = await _geocoder.getGeocode(GeocodeRequest(
        geocode: PointGeocode(latitude: lat, longitude: lon),
        lang: Lang.ru,
      ));
      return response.firstAddress?.formatted;
    } catch (e) {
      print('Reverse geocoding error: $e');
      return null;
    }
  }
}
```

---

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### 1. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å API

#### Rate Limiting
```typescript
// –ó–∞—â–∏—Ç–∞ –æ—Ç brute-force –∞—Ç–∞–∫
const authLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 5,
  message: '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.',
});
```

#### Helmet.js
```typescript
// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö HTTP –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
app.use(helmet());
```

#### CORS
```typescript
app.use(cors({
  origin: process.env.ALLOWED_ORIGINS?.split(',') || '*',
  credentials: true,
}));
```

### 2. –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

#### Zod Schema Validation
```typescript
import { z } from 'zod';

const createEventSchema = z.object({
  title: z.string().min(3).max(100),
  description: z.string().min(10).max(5000),
  category: z.string(),
  latitude: z.number().min(-90).max(90),
  longitude: z.number().min(-180).max(180),
  dateTime: z.string().datetime(),
  price: z.number().min(0).optional(),
});
```

### 3. SQL Injection –∑–∞—â–∏—Ç–∞

Prisma –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç SQL injection, –Ω–æ –¥–ª—è raw queries –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã:

```typescript
// ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ (–ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π)
await prisma.$queryRaw`
  SELECT * FROM "User" WHERE email = ${userEmail}
`;

// ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ (—É—è–∑–≤–∏–º–æ)
await prisma.$queryRawUnsafe(`
  SELECT * FROM "User" WHERE email = '${userEmail}'
`);
```

### 4. Path Traversal –∑–∞—â–∏—Ç–∞

```typescript
function sanitizeFilename(filename: string): string {
  return filename
    .replaceAll('..', '')
    .replaceAll(/[/\\]/g, '')
    .replaceAll(/[^\w\s.-]/g, '')
    .trim();
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø—É—Ç–∏
const realUploadDir = fs.realpathSync(baseUploadDir);
const realTargetDir = fs.realpathSync(uploadDir);

if (!realTargetDir.startsWith(realUploadDir)) {
  throw new Error('Path traversal attempt detected');
}
```

### 5. XSS –∑–∞—â–∏—Ç–∞

```dart
// Flutter –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –≤ Text()
Text(userInput);  // –ë–µ–∑–æ–ø–∞—Å–Ω–æ

// –î–ª—è HTML –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ flutter_html
Html(data: sanitizeHtml(userHtml));
```

### 6. –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤

```bash
# .env (–ù–ï –∫–æ–º–º–∏—Ç–∏—Ç—å!)
DATABASE_URL="postgresql://..."
SUPABASE_JWT_SECRET="..."
YANDEX_MAPS_API_KEY="..."
```

```dart
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ --dart-define
flutter run --dart-define=API_BASE_URL=https://api.example.com
```

### 7. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø–∞—Ä–æ–ª–µ–π

```typescript
import bcrypt from 'bcrypt';

// –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
const hashedPassword = await bcrypt.hash(password, 10);

// –ü—Ä–æ–≤–µ—Ä–∫–∞
const isValid = await bcrypt.compare(password, hashedPassword);
```

### 8. HTTPS Only (Production)

```typescript
if (process.env.NODE_ENV === 'production') {
  app.use((req, res, next) => {
    if (req.header('x-forwarded-proto') !== 'https') {
      return res.redirect(`https://${req.header('host')}${req.url}`);
    }
    next();
  });
}
```

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

**‚úÖ –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
- Prisma ORM —Å PostgreSQL
- PostGIS –¥–ª—è –≥–µ–æ–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –ò–Ω–¥–µ–∫—Å—ã –Ω–∞ –∫–ª—é—á–µ–≤—ã—Ö –ø–æ–ª—è—Ö

**üîß –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**

1. **–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Å—Ç–∞–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã:**
```prisma
model Event {
  @@index([status, dateTime])
  @@index([category, status])
  @@index([createdById, status])
}
```

2. **–î–æ–±–∞–≤–∏—Ç—å GIST –∏–Ω–¥–µ–∫—Å –¥–ª—è locationGeo:**
```sql
CREATE INDEX event_location_gist_idx ON "Event" USING GIST ("locationGeo");
```

3. **–ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã Event –ø–æ –¥–∞—Ç–µ:**
```sql
-- –î–ª—è –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ —Å—Ç–∞—Ä—ã—Ö —Å–æ–±—ã—Ç–∏–π
CREATE TABLE event_2024 PARTITION OF "Event"
  FOR VALUES FROM ('2024-01-01') TO ('2025-01-01');
```

4. **–î–æ–±–∞–≤–∏—Ç—å soft delete:**
```prisma
model Event {
  deletedAt DateTime?
  
  @@index([deletedAt])
}
```

### 2. –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å Redis:**

```typescript
import Redis from 'ioredis';

const redis = new Redis(process.env.REDIS_URL);

// –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å–æ–±—ã—Ç–∏–π
async function getCachedEvents(cacheKey: string) {
  const cached = await redis.get(cacheKey);
  if (cached) return JSON.parse(cached);
  
  const events = await eventService.getAllEvents();
  await redis.setex(cacheKey, 300, JSON.stringify(events)); // 5 –º–∏–Ω—É—Ç
  return events;
}
```

**–ß—Ç–æ –∫–µ—à–∏—Ä–æ–≤–∞—Ç—å:**
- –°–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π (–Ω–∞ 5 –º–∏–Ω—É—Ç)
- –ü—Ä–æ—Ñ–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–Ω–∞ 10 –º–∏–Ω—É—Ç)
- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≥–µ–æ–∫–æ–¥–∏–Ω–≥–∞ (–Ω–∞ 1 –¥–µ–Ω—å)
- –ü–æ–¥—Å—á—ë—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏—è (–Ω–∞ 1 –º–∏–Ω—É—Ç—É)

### 3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:**

1. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è thumbnails:**
```typescript
// –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å 3 –≤–µ—Ä—Å–∏–∏
await Promise.all([
  sharp(input).resize(1200, 1200).toFile('large.jpg'),
  sharp(input).resize(600, 600).toFile('medium.jpg'),
  sharp(input).resize(200, 200).toFile('thumb.jpg'),
]);
```

2. **WebP —Ñ–æ—Ä–º–∞—Ç:**
```typescript
await sharp(input)
  .webp({ quality: 80 })
  .toFile('image.webp');
```

3. **Lazy loading –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ:**
```dart
CachedNetworkImage(
  imageUrl: event.imageUrl,
  placeholder: (context, url) => CircularProgressIndicator(),
  errorWidget: (context, url, error) => Icon(Icons.error),
);
```

### 4. –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è production:**

1. **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   API Server ‚îÇ ‚Üê –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Upload Server‚îÇ ‚Üê –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  WebSocket   ‚îÇ ‚Üê –†–µ–∞–ª—Ç–∞–π–º (–º–∞—Ç—á–∏, —á–∞—Ç)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

2. **–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```nginx
upstream api_servers {
  server api1.example.com;
  server api2.example.com;
  server api3.example.com;
}
```

3. **CDN –¥–ª—è —Å—Ç–∞—Ç–∏–∫–∏:**
```typescript
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å CloudFront, Cloudflare –∏–ª–∏ Akamai
const imageUrl = `${CDN_URL}/uploads/events/${filename}`;
```

### 5. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å:**

1. **Sentry –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫:**
```typescript
import * as Sentry from '@sentry/node';

Sentry.init({ dsn: process.env.SENTRY_DSN });

app.use(Sentry.Handlers.errorHandler());
```

2. **Prometheus –º–µ—Ç—Ä–∏–∫–∏:**
```typescript
import promClient from 'prom-client';

const httpRequestDuration = new promClient.Histogram({
  name: 'http_request_duration_seconds',
  help: 'Duration of HTTP requests in seconds',
  labelNames: ['method', 'route', 'status_code'],
});
```

3. **Health checks:**
```typescript
app.get('/health', async (req, res) => {
  try {
    await prisma.$queryRaw`SELECT 1`;
    res.json({ status: 'healthy', database: 'connected' });
  } catch (error) {
    res.status(503).json({ status: 'unhealthy', database: 'disconnected' });
  }
});
```

### 6. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å:**

1. **Unit —Ç–µ—Å—Ç—ã (Jest):**
```typescript
describe('EventService', () => {
  it('should create event with valid data', async () => {
    const event = await eventService.createEvent(mockEventData);
    expect(event.id).toBeDefined();
    expect(event.status).toBe('PENDING');
  });
});
```

2. **Integration —Ç–µ—Å—Ç—ã:**
```typescript
describe('POST /api/events', () => {
  it('should return 401 without auth token', async () => {
    const res = await request(app)
      .post('/api/events')
      .send(mockEventData);
    expect(res.status).toBe(401);
  });
});
```

3. **E2E —Ç–µ—Å—Ç—ã (Flutter):**
```dart
testWidgets('should create event successfully', (tester) async {
  await tester.pumpWidget(MyApp());
  await tester.tap(find.byIcon(Icons.add));
  await tester.pumpAndSettle();
  
  expect(find.text('Create Event'), findsOneWidget);
});
```

### 7. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ)

1. **–î–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:**
```typescript
import speakeasy from 'speakeasy';

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–µ–∫—Ä–µ—Ç–∞
const secret = speakeasy.generateSecret();

// –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –∫–æ–¥–∞
const verified = speakeasy.totp.verify({
  secret: user.totpSecret,
  encoding: 'base32',
  token: userCode,
});
```

2. **Audit log:**
```prisma
model AuditLog {
  id        String   @id @default(uuid())
  userId    String
  action    String   // CREATE_EVENT, DELETE_USER, etc.
  entityId  String
  entityType String
  metadata  Json?
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}
```

3. **IP Whitelist –¥–ª—è –∞–¥–º–∏–Ω–∫–∏:**
```typescript
const adminWhitelist = ['192.168.1.1', '10.0.0.1'];

app.use('/admin', (req, res, next) => {
  if (!adminWhitelist.includes(req.ip)) {
    return res.status(403).json({ message: 'Access denied' });
  }
  next();
});
```

### 8. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å Flutter

1. **–í–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è —Å–ø–∏—Å–∫–æ–≤:**
```dart
ListView.builder(
  itemCount: events.length,
  itemBuilder: (context, index) => EventCard(events[index]),
);
```

2. **–ú–µ–º–æ–∏–∑–∞—Ü–∏—è –≤–∏–¥–∂–µ—Ç–æ–≤:**
```dart
class EventCard extends StatelessWidget {
  const EventCar